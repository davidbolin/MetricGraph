<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="MetricGraph">
<title>Comparison of different models using real data • MetricGraph</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto_Slab-0.4.8/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Comparison of different models using real data">
<meta property="og:description" content="MetricGraph">
<meta property="og:image" content="https://davidbolin.github.io/MetricGraph/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">MetricGraph</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/MetricGraph.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Functions</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-vignettes">Vignettes</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-vignettes">
    <a class="dropdown-item" href="../articles/metric_graph.html">Working with metric graphs</a>
    <a class="dropdown-item" href="../articles/random_fields.html">Gaussian random fields on metric graphs</a>
    <a class="dropdown-item" href="../articles/metric_graph_data.html">Data manipulation on metric graphs</a>
    <a class="dropdown-item" href="../articles/inlabru_interface.html">inlabru interface of Whittle--Matérn fields</a>
    <a class="dropdown-item" href="../articles/inla_interface.html">INLA interface of Whittle--Matérn fields</a>
    <a class="dropdown-item" href="../articles/fem_models.html">Whittle--Matérn fields with general smoothness</a>
    <a class="dropdown-item" href="../articles/pointprocess.html">Log-Gaussian Cox processes on metric graphs</a>
    <a class="dropdown-item" href="../articles/comparison.html">Comparison of different models using real data</a>
    <a class="dropdown-item" href="../articles/isotropic_noneuclidean.html">On isotropic covariances on metric graphs with non-Euclidean edges</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/davidbolin/MetricGraph/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://twitter.com/jdavidbolin" aria-label="Twitter">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Comparison of different models using real data</h1>
                        <h4 data-toc-skip class="author">David Bolin,
Alexandre B. Simas, and Jonas Wallin</h4>
            
            <h4 data-toc-skip class="date">Created: 2024-02-09. Last
modified: 2024-02-22.</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/davidbolin/MetricGraph/blob/HEAD/vignettes/comparison.rmd" class="external-link"><code>vignettes/comparison.rmd</code></a></small>
      <div class="d-none name"><code>comparison.rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this vignette our goal is to compare the predictive power of
different models on metric graphs by cross-validation. More precisely,
we consider the Whittle–Matérn fields introduced by <a href="https://arxiv.org/abs/2205.06163" class="external-link"><span class="citation">Bolin,
Simas, and Wallin (2024)</span></a> and <a href="https://arxiv.org/abs/2304.10372" class="external-link"><span class="citation">Bolin,
Simas, and Wallin (2023)</span></a>, a Gaussian random field with an
isotropic exponential covariance function <a href="https://projecteuclid.org/journals/annals-of-statistics/volume-48/issue-4/Isotropic-covariance-functions-on-graphs-and-their-edges/10.1214/19-AOS1896.full" class="external-link"><span class="citation">Anderes, Møller, and Rasmussen (2020)</span></a>, and
Matérn Gaussian processes based on the graph Laplacian <a href="http://proceedings.mlr.press/v130/borovitskiy21a/borovitskiy21a.pdf" class="external-link"><span class="citation">Borovitskiy et al. (2021)</span></a>.</p>
</div>
<div class="section level2">
<h2 id="the-dataset">The dataset<a class="anchor" aria-label="anchor" href="#the-dataset"></a>
</h2>
<p>For this example we will consider the <code>pems</code> data
contained in the <code>MetricGraph</code> package. The data consists of
traffic speed observations on highways in the city of San Jose,
California. The variable <code>y</code> contains the traffic speeds.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="va">pems_graph</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/metric_graph.html">metric_graph</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>edges <span class="op">=</span> <span class="va">pems</span><span class="op">$</span><span class="va">edges</span>, longlat<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span> <span class="va">pems_graph</span><span class="op">$</span><span class="fu">add_observations</span><span class="op">(</span>data <span class="op">=</span> <span class="va">pems</span><span class="op">$</span><span class="va">data</span>, normalized<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span> <span class="va">pems_graph</span><span class="op">$</span><span class="fu">prune_vertices</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Let us take a look at the observations:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>data <span class="op">=</span> <span class="st">"y"</span>, vertex_size <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-2-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="the-models">The models<a class="anchor" aria-label="anchor" href="#the-models"></a>
</h2>
<p>We will assume that the data has the following structure:</p>
<p><span class="math display">\[
y_i = \mu + u(s_i) + \varepsilon_i, \quad i=1,\ldots,n,
\]</span> where <span class="math inline">\(\mu\)</span> is a constant
that represents the mean of the field, <span class="math inline">\(u(\cdot)\)</span> is a Gaussian random field,
<span class="math inline">\(s_i\in \Gamma\)</span> are observation
locations and <span class="math inline">\(\varepsilon_i\)</span> are
independent centered Gaussian variables <span class="math inline">\(N(0,\sigma_e^2)\)</span> representing measurement
noise.</p>
<p>Let us fit the different models, that is, we will assume several
different possible latent fields <span class="math inline">\(u(\cdot)\)</span>. We start by fitting a
Whittle-Matérn field with <code>alpha = 1</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_alpha1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_lme.html">graph_lme</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, graph<span class="op">=</span><span class="va">pems_graph</span>, </span>
<span>            model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"WhittleMatern"</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>and look at its summary:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_alpha1</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Latent model - Whittle-Matern with alpha = 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; graph_lme(formula = y ~ 1, graph = pems_graph, model = list(type = "WhittleMatern", </span></span>
<span><span class="co">#&gt;     alpha = 1))</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;             Estimate Std.error z-value Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; (Intercept)   51.202     4.111   12.45   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;       Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; tau   0.104413  0.007828  13.338</span></span>
<span><span class="co">#&gt; kappa 0.108770  0.049942   2.178</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects (Matern parameterization):</span></span>
<span><span class="co">#&gt;       Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; sigma   20.534     4.355   4.715</span></span>
<span><span class="co">#&gt; range   18.387     8.426   2.182</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Measurement error:</span></span>
<span><span class="co">#&gt;          Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; std. dev   6.8665    0.4086    16.8</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Log-Likelihood:  -1221.337 </span></span>
<span><span class="co">#&gt; Number of function calls by 'optim' = 29</span></span>
<span><span class="co">#&gt; Optimization method used in 'optim' = L-BFGS-B</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Time used to:     fit the model =  14.20334 secs</span></span></code></pre></div>
<p>Now, we will fit a Whittle-Matérn field with
<code>alpha = 2</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_alpha2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_lme.html">graph_lme</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, graph<span class="op">=</span><span class="va">pems_graph</span>, </span>
<span>            model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"WhittleMatern"</span>, alpha <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>and its summary:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_alpha2</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Latent model - Whittle-Matern with alpha = 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; graph_lme(formula = y ~ 1, graph = pems_graph, model = list(type = "WhittleMatern", </span></span>
<span><span class="co">#&gt;     alpha = 2))</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;             Estimate Std.error z-value Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; (Intercept)   50.850     2.652   19.18   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;       Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; tau    0.07528   0.01420   5.302</span></span>
<span><span class="co">#&gt; kappa  0.49552   0.08698   5.697</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects (Matern parameterization):</span></span>
<span><span class="co">#&gt;       Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; sigma   19.042     2.461   7.737</span></span>
<span><span class="co">#&gt; range    6.991     1.188   5.884</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Measurement error:</span></span>
<span><span class="co">#&gt;          Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; std. dev   7.4751    0.3917   19.09</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Log-Likelihood:  -1216.806 </span></span>
<span><span class="co">#&gt; Number of function calls by 'optim' = 16</span></span>
<span><span class="co">#&gt; Optimization method used in 'optim' = L-BFGS-B</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Time used to:     fit the model =  14.65449 secs</span></span></code></pre></div>
<p>We will now fit Whittle-Matérn fields with <code>alpha = 1</code> and
<code>alpha=2</code>, and by performing a boundary correction on
vertices of degree 1. To such an end, we set <code>BC=1</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_alpha1_bc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_lme.html">graph_lme</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, graph<span class="op">=</span><span class="va">pems_graph</span>, BC <span class="op">=</span> <span class="fl">1</span>,</span>
<span>        model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"WhittleMatern"</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_alpha2_bc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_lme.html">graph_lme</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, graph<span class="op">=</span><span class="va">pems_graph</span>, BC <span class="op">=</span> <span class="fl">1</span>,</span>
<span>        model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"WhittleMatern"</span>, alpha <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now, let us look at the summaries:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_alpha1_bc</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Latent model - Whittle-Matern with alpha = 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; graph_lme(formula = y ~ 1, graph = pems_graph, model = list(type = "WhittleMatern", </span></span>
<span><span class="co">#&gt;     alpha = 1), BC = 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;             Estimate Std.error z-value Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; (Intercept)   51.155     4.285   11.94   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;       Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; tau   0.104561  0.007831  13.352</span></span>
<span><span class="co">#&gt; kappa 0.095349  0.051226   1.861</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects (Matern parameterization):</span></span>
<span><span class="co">#&gt;       Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; sigma   21.901     5.468   4.005</span></span>
<span><span class="co">#&gt; range   20.976    11.247   1.865</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Measurement error:</span></span>
<span><span class="co">#&gt;          Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; std. dev   6.8673    0.4085   16.81</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Log-Likelihood:  -1221.489 </span></span>
<span><span class="co">#&gt; Number of function calls by 'optim' = 32</span></span>
<span><span class="co">#&gt; Optimization method used in 'optim' = L-BFGS-B</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Time used to:     fit the model =  15.71714 secs</span></span></code></pre></div>
<p>and</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_alpha2_bc</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Latent model - Whittle-Matern with alpha = 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; graph_lme(formula = y ~ 1, graph = pems_graph, model = list(type = "WhittleMatern", </span></span>
<span><span class="co">#&gt;     alpha = 2), BC = 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;             Estimate Std.error z-value Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; (Intercept)   50.850     2.683   18.95   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;       Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; tau    0.07626   0.01446   5.275</span></span>
<span><span class="co">#&gt; kappa  0.48068   0.08719   5.513</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects (Matern parameterization):</span></span>
<span><span class="co">#&gt;       Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; sigma   19.672     2.659   7.398</span></span>
<span><span class="co">#&gt; range    7.207     1.266   5.693</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Measurement error:</span></span>
<span><span class="co">#&gt;          Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; std. dev   7.4779    0.3913   19.11</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Log-Likelihood:  -1217.021 </span></span>
<span><span class="co">#&gt; Number of function calls by 'optim' = 18</span></span>
<span><span class="co">#&gt; Optimization method used in 'optim' = L-BFGS-B</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Time used to:     fit the model =  16.28154 secs</span></span></code></pre></div>
<p>Similarly, let us now fit a Matérn Gaussian model based on the graph
Laplacian for <code>alpha=1</code> and <code>alpha=2</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_GL1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_lme.html">graph_lme</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, graph<span class="op">=</span><span class="va">pems_graph</span>, </span>
<span>            model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"graphLaplacian"</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in graph_lme(y ~ 1, graph = pems_graph, model = list(type =</span></span>
<span><span class="co">#&gt; "graphLaplacian", : All optimization methods failed to provide a</span></span>
<span><span class="co">#&gt; positive-definite Hessian. The optimization method with largest likelihood was</span></span>
<span><span class="co">#&gt; chosen. You can try to obtain a positive-definite Hessian by setting</span></span>
<span><span class="co">#&gt; 'improve_hessian' to TRUE.</span></span>
<span><span class="co">#&gt; Warning in sqrt(diag(inv_fisher)): NaNs produced</span></span>
<span></span>
<span><span class="va">fit_GL2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_lme.html">graph_lme</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, graph<span class="op">=</span><span class="va">pems_graph</span>,</span>
<span>            model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"graphLaplacian"</span>, alpha <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>and look at their summaries:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_GL1</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Latent model - graph Laplacian SPDE with alpha = 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; graph_lme(formula = y ~ 1, graph = pems_graph, model = list(type = "graphLaplacian", </span></span>
<span><span class="co">#&gt;     alpha = 1))</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;             Estimate Std.error z-value Pr(&gt;|z|)</span></span>
<span><span class="co">#&gt; (Intercept)    38.78       NaN     NaN      NaN</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;       Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; tau   0.106588  0.007586   14.05</span></span>
<span><span class="co">#&gt; kappa 0.030622       NaN     NaN</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects (Matern parameterization):</span></span>
<span><span class="co">#&gt;       Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; sigma    37.91     13.31   2.848</span></span>
<span><span class="co">#&gt; range    65.31     46.66   1.400</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Measurement error:</span></span>
<span><span class="co">#&gt;          Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; std. dev   6.8994    0.4092   16.86</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Log-Likelihood:  -1223.056 </span></span>
<span><span class="co">#&gt; Number of function calls by 'optim' = 205</span></span>
<span><span class="co">#&gt; Optimization method used in 'optim' = L-BFGS-B</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Time used to:     fit the model =  1.36629 secs</span></span></code></pre></div>
<p>and</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_GL2</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Latent model - graph Laplacian SPDE with alpha = 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; graph_lme(formula = y ~ 1, graph = pems_graph, model = list(type = "graphLaplacian", </span></span>
<span><span class="co">#&gt;     alpha = 2))</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;             Estimate Std.error z-value Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; (Intercept)   51.394     2.883   17.83   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;       Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; tau    0.12680   0.02152   5.892</span></span>
<span><span class="co">#&gt; kappa  0.32736   0.05672   5.772</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects (Matern parameterization):</span></span>
<span><span class="co">#&gt;       Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; sigma   21.053     3.038   6.930</span></span>
<span><span class="co">#&gt; range   10.582     1.771   5.975</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Measurement error:</span></span>
<span><span class="co">#&gt;          Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; std. dev   7.1607    0.3888   18.42</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Log-Likelihood:  -1209.003 </span></span>
<span><span class="co">#&gt; Number of function calls by 'optim' = 62</span></span>
<span><span class="co">#&gt; Optimization method used in 'optim' = L-BFGS-B</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Time used to:     fit the model =  3.61934 secs</span></span></code></pre></div>
<p>Observe that the default optimizer (L-BFGS-B) failed to converge,
thus an alternative optimizer was used, when fitting the graph Laplacian
model with <code>alpha=2</code>.</p>
<p>Let us now fit a Gaussian field with isotropic exponential covariance
function:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_isoexp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_lme.html">graph_lme</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, graph<span class="op">=</span><span class="va">pems_graph</span>, </span>
<span>                model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"isoCov"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in graph_lme(y ~ 1, graph = pems_graph, model = list(type = "isoCov")):</span></span>
<span><span class="co">#&gt; No check for Euclidean edges have been perfomed on this graph. The isotropic</span></span>
<span><span class="co">#&gt; covariance models are only known to work for graphs with Euclidean edges. You</span></span>
<span><span class="co">#&gt; can check if the graph has Euclidean edges by running the `check_euclidean()`</span></span>
<span><span class="co">#&gt; method. See the vignette</span></span>
<span><span class="co">#&gt; https://davidbolin.github.io/MetricGraph/articles/isotropic_noneuclidean.html</span></span>
<span><span class="co">#&gt; for further details.</span></span></code></pre></div>
<p>and look at the summary:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_isoexp</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Latent model - Covariance-based model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; graph_lme(formula = y ~ 1, graph = pems_graph, model = list(type = "isoCov"))</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;             Estimate Std.error z-value Pr(&gt;|z|)</span></span>
<span><span class="co">#&gt; (Intercept)    33.08     24.22   1.366    0.172</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;       Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; tau   31.23132  16.36467   1.908</span></span>
<span><span class="co">#&gt; kappa  0.04609   0.05046   0.913</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Measurement error:</span></span>
<span><span class="co">#&gt;          Estimate Std.error z-value</span></span>
<span><span class="co">#&gt; std. dev    6.877     0.409   16.82</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Log-Likelihood:  -1223.773 </span></span>
<span><span class="co">#&gt; Number of function calls by 'optim' = 40</span></span>
<span><span class="co">#&gt; Optimization method used in 'optim' = L-BFGS-B</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Time used to:     fit the model =  9.27647 secs</span></span></code></pre></div>
<p>Observe the warning, message. This message tells us that we did not
check if the metric graph has Euclidean edges. Let us check now:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pems_graph</span><span class="op">$</span><span class="fu">check_euclidean</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Now, we can look at the graph’s characteristics contained in this
summary:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">pems_graph</span><span class="op">)</span></span>
<span><span class="co">#&gt; A metric graph object with:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Vertices:</span></span>
<span><span class="co">#&gt;   Total: 347 </span></span>
<span><span class="co">#&gt;   Degree 1: 11;  Degree 2: 16;  Degree 3: 315;  Degree 4: 5; </span></span>
<span><span class="co">#&gt;   With incompatible directions:  17 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Edges: </span></span>
<span><span class="co">#&gt;   Total: 504 </span></span>
<span><span class="co">#&gt;   Lengths: </span></span>
<span><span class="co">#&gt;       Min: 0.01040218  ; Max: 7.677232  ; Total: 470.7559 </span></span>
<span><span class="co">#&gt;   Weights: </span></span>
<span><span class="co">#&gt;       Min: 1  ; Max: 1 </span></span>
<span><span class="co">#&gt;   That are circles:  0 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Graph units: </span></span>
<span><span class="co">#&gt;   Vertices unit:  degrees  ; Lengths unit:  km </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Longitude and Latitude coordinates:  TRUE</span></span>
<span><span class="co">#&gt;   Which spatial package:  sp </span></span>
<span><span class="co">#&gt;   CRS:  +proj=longlat +datum=WGS84 +no_defs</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Some characteristics of the graph:</span></span>
<span><span class="co">#&gt;   Connected: TRUE</span></span>
<span><span class="co">#&gt;   Has loops: FALSE</span></span>
<span><span class="co">#&gt;   Has multiple edges: TRUE</span></span>
<span><span class="co">#&gt;   Is a tree: FALSE</span></span>
<span><span class="co">#&gt;   Distance consistent: FALSE</span></span>
<span><span class="co">#&gt;   Has Euclidean edges: FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computed quantities inside the graph: </span></span>
<span><span class="co">#&gt;   Laplacian:  FALSE  ; Geodesic distances:  TRUE </span></span>
<span><span class="co">#&gt;   Resistance distances:  FALSE  ; Finite element matrices:  FALSE </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Mesh: The graph has no mesh! </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Data: </span></span>
<span><span class="co">#&gt;   Columns:  y </span></span>
<span><span class="co">#&gt;   Groups:  None </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Tolerances: </span></span>
<span><span class="co">#&gt;   vertex-vertex:  0.001 </span></span>
<span><span class="co">#&gt;   vertex-edge:  0.001 </span></span>
<span><span class="co">#&gt;   edge-edge:  0</span></span></code></pre></div>
<p>Thus, this graph does not have Euclidean edges. This means, when we
fit the model, we actually modify the graph, when we add the
obvservations as vertices. By default, when fitting isotropic models,
the <code><a href="../reference/graph_lme.html">graph_lme()</a></code> function checks it the metric graph after
adding the observations as vertices has Euclidean edges. We can check by
looking at the <code>euclidean</code> element of the fitted model:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_isoexp</span><span class="op">$</span><span class="va">euclidean</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>Therefore, even after adding the observations as vertices, the metric
graph is still not Euclidean.</p>
<p>Let us check if we can fit an isotropic model with isotropic Matérn
covariance function with smoothness parameter <code>nu=1.5</code> (which
corresponds to <code>alpha=2</code> for Whittle-Matérn fields and Matérn
Gaussian models based on the graph Laplacian). Recall that by the
results in <a href="https://projecteuclid.org/journals/annals-of-statistics/volume-48/issue-4/Isotropic-covariance-functions-on-graphs-and-their-edges/10.1214/19-AOS1896.full" class="external-link"><span class="citation">Anderes, Møller, and Rasmussen (2020)</span></a>, it is
not guaranteed that such a function will be a valid covariance function
even on an metric graph with Euclidean edges.</p>
<p>We start by defining the Matérn covariance:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cov_mat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">h</span>,<span class="va">theta</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">nu</span> <span class="op">&lt;-</span> <span class="fl">1.5</span></span>
<span>    <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">kappa</span> <span class="op">&lt;-</span> <span class="va">theta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>    <span class="op">(</span><span class="va">sigma</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="op">(</span><span class="fl">2</span><span class="op">^</span><span class="op">(</span><span class="va">nu</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html" class="external-link">gamma</a></span><span class="op">(</span><span class="va">nu</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="va">kappa</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">h</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="va">nu</span><span class="op">)</span> <span class="op">*</span> </span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Bessel.html" class="external-link">besselK</a></span><span class="op">(</span><span class="va">kappa</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">h</span><span class="op">)</span>, <span class="va">nu</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span></code></pre></div>
<p>Let us now fit the model:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_isomat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_lme.html">graph_lme</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, graph <span class="op">=</span> <span class="va">pems_graph</span>, </span>
<span>                            model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"isoCov"</span>, cov_function <span class="op">=</span> <span class="va">cov_mat</span><span class="op">)</span>, </span>
<span>                                    model_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>start_par_vec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in graph_lme(y ~ 1, graph = pems_graph, model = list(type = "isoCov", :</span></span>
<span><span class="co">#&gt; This graph DOES NOT have Euclidean edges. The isotropic covariance models are</span></span>
<span><span class="co">#&gt; NOT guaranteed to work for this graph! See the vignette</span></span>
<span><span class="co">#&gt; https://davidbolin.github.io/MetricGraph/articles/isotropic_noneuclidean.html</span></span>
<span><span class="co">#&gt; for further details.</span></span>
<span><span class="co">#&gt; Warning in graph_lme(y ~ 1, graph = pems_graph, model = list(type = "isoCov", :</span></span>
<span><span class="co">#&gt; All optimization methods failed to provide a positive-definite Hessian. The</span></span>
<span><span class="co">#&gt; optimization method with largest likelihood was chosen. You can try to obtain a</span></span>
<span><span class="co">#&gt; positive-definite Hessian by setting 'improve_hessian' to TRUE.</span></span>
<span><span class="co">#&gt; Warning in new_theta[!fix_vec_full] &lt;- theta: number of items to replace is not</span></span>
<span><span class="co">#&gt; a multiple of replacement length</span></span>
<span><span class="co">#&gt; Error in chol.default(Sigma_non_na): the leading minor of order 1 is not positive</span></span></code></pre></div>
<p>Indeed, the model could not be fitted.</p>
</div>
<div class="section level2">
<h2 id="comparison-by-cross-validation">Comparison by cross-validation<a class="anchor" aria-label="anchor" href="#comparison-by-cross-validation"></a>
</h2>
<p>We will now use the function <code><a href="../reference/posterior_crossvalidation.html">posterior_crossvalidation()</a></code>
to perform leave-one-out cross validation based on the estimated
parameters and compare the results:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted_models_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"alpha=1"</span> <span class="op">=</span> <span class="va">fit_alpha1</span>, </span>
<span>                    <span class="st">"alpha=2"</span> <span class="op">=</span> <span class="va">fit_alpha2</span>, </span>
<span>                    <span class="st">"isoExp"</span> <span class="op">=</span> <span class="va">fit_isoexp</span>, </span>
<span>                    <span class="st">"GL1"</span> <span class="op">=</span> <span class="va">fit_GL1</span>, <span class="st">"GL2"</span> <span class="op">=</span> <span class="va">fit_GL2</span>,</span>
<span>                    <span class="st">"alpha=1 bc"</span> <span class="op">=</span> <span class="va">fit_alpha1_bc</span>,</span>
<span>                    <span class="st">"alpha=2 bc"</span> <span class="op">=</span> <span class="va">fit_alpha2_bc</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/posterior_crossvalidation.html">posterior_crossvalidation</a></span><span class="op">(</span><span class="va">fitted_models_list</span>, factor <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span><span class="op">[[</span><span class="st">"scores"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 7 × 6</span></span></span>
<span><span class="co">#&gt;   Model      logscore  crps scrps   mae  rmse</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> alpha=1       <span style="text-decoration: underline;">3</span>605. <span style="text-decoration: underline;">4</span>738. <span style="text-decoration: underline;">2</span>133. <span style="text-decoration: underline;">6</span>179. <span style="text-decoration: underline;">8</span>615.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> alpha=2       <span style="text-decoration: underline;">3</span>556. <span style="text-decoration: underline;">4</span>547. <span style="text-decoration: underline;">2</span>111. <span style="text-decoration: underline;">5</span>854. <span style="text-decoration: underline;">8</span>272.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> isoExp        <span style="text-decoration: underline;">3</span>603. <span style="text-decoration: underline;">4</span>735. <span style="text-decoration: underline;">2</span>133. <span style="text-decoration: underline;">6</span>180. <span style="text-decoration: underline;">8</span>608.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> GL1           <span style="text-decoration: underline;">3</span>603. <span style="text-decoration: underline;">4</span>732. <span style="text-decoration: underline;">2</span>132. <span style="text-decoration: underline;">6</span>166. <span style="text-decoration: underline;">8</span>601.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> GL2           <span style="text-decoration: underline;">3</span>557. <span style="text-decoration: underline;">4</span>558. <span style="text-decoration: underline;">2</span>110. <span style="text-decoration: underline;">5</span>894. <span style="text-decoration: underline;">8</span>354.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> alpha=1 bc    <span style="text-decoration: underline;">3</span>605. <span style="text-decoration: underline;">4</span>737. <span style="text-decoration: underline;">2</span>133. <span style="text-decoration: underline;">6</span>169. <span style="text-decoration: underline;">8</span>613.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> alpha=2 bc    <span style="text-decoration: underline;">3</span>556. <span style="text-decoration: underline;">4</span>546. <span style="text-decoration: underline;">2</span>111. <span style="text-decoration: underline;">5</span>853. <span style="text-decoration: underline;">8</span>272.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="kriging">Kriging<a class="anchor" aria-label="anchor" href="#kriging"></a>
</h2>
<p>We will now perform kriging with the different fitted models. Observe
that for the Matérn Gaussian model based on the graph Laplacian and the
Gaussian model with isotropic exponential covariance function, we
actually modify the model when doing predictions. See the <a href="isotropic_noneuclidean.html">On isotropic covariances on metric
graphs with non-Euclidean edges</a> vignette for further details.</p>
<p>Therefore, even though we are able to obtain ``predictions’’ using
the Matérn Gaussian models based on graph Laplacian and the Gaussian
models with istropic exponential covariance function, there are some
inconsistencies between the model used to fit the data, and the model
used to obtain predictions. Such inconsistency is not present in the
Whittle-Matérn models on metric graphs.</p>
<p>Let us begin by building a mesh on the metric graph and create a
<code><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame()</a></code> with such mesh locations:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pems_graph</span><span class="op">$</span><span class="fu">build_mesh</span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>edge_number <span class="op">=</span> <span class="va">pems_graph</span><span class="op">$</span><span class="va">mesh</span><span class="op">$</span><span class="va">PtE</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>                        distance_on_edge <span class="op">=</span> <span class="va">pems_graph</span><span class="op">$</span><span class="va">mesh</span><span class="op">$</span><span class="va">PtE</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>As the region is very large, we will select two smaller subregions to
``zoom in’’, so we can see the predictions with more details. Let us
create variables containing the coordinates of such regions:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coordx_lwr1</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">121.905</span></span>
<span><span class="va">coordx_upr1</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">121.875</span></span>
<span><span class="va">coordy_lwr1</span> <span class="op">&lt;-</span> <span class="fl">37.316</span></span>
<span><span class="va">coordy_upr1</span> <span class="op">&lt;-</span> <span class="fl">37.328</span></span></code></pre></div>
<p>Now, for the second region:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coordx_lwr2</span><span class="op">&lt;-</span> <span class="op">-</span><span class="fl">121.94</span></span>
<span><span class="va">coordx_upr2</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">121.88</span></span>
<span><span class="va">coordy_lwr2</span> <span class="op">&lt;-</span> <span class="fl">37.35</span></span>
<span><span class="va">coordy_upr2</span> <span class="op">&lt;-</span> <span class="fl">37.38</span></span></code></pre></div>
<p>We can now obtain the predictions. We will use the
<code><a href="../reference/augment.graph_lme.html">augment()</a></code> method to obtain such predictions. We start by
obtaining predictions for the Whittle-Matérn models with
<code>alpha=1</code>:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_alpha1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/augment.graph_lme.html">augment</a></span><span class="op">(</span><span class="va">fit_alpha1</span>, newdata <span class="op">=</span> <span class="va">df_pred</span>,</span>
<span>                        normalized <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>and with boundary correction:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_alpha1_bc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/augment.graph_lme.html">augment</a></span><span class="op">(</span><span class="va">fit_alpha1_bc</span>, newdata <span class="op">=</span> <span class="va">df_pred</span>,</span>
<span>                        normalized <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Let plot the predictions with the corresponding observed values.
First for the model without boundary correction. As the predictions were
obtained on the mesh nodes, we can supply the fitted values into the
<code>X</code> argument of the <code>plot_function()</code> method:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot_function</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">pred_alpha1</span>, data <span class="op">=</span> <span class="st">".fitted"</span>,</span>
<span>                improve_plot<span class="op">=</span><span class="cn">TRUE</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                edge_width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> </span></code></pre></div>
<p>We can now add the original observations obtain the plot in region
1:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>data <span class="op">=</span> <span class="st">"y"</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>, data_size <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0</span>, p <span class="op">=</span> <span class="va">p</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="va">coordx_lwr1</span>, <span class="va">coordx_upr1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">coordy_lwr1</span>, <span class="va">coordy_upr1</span><span class="op">)</span>                </span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-27-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Now in region 2:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>data <span class="op">=</span> <span class="st">"y"</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>, data_size <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0</span>, p <span class="op">=</span> <span class="va">p</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="va">coordx_lwr2</span>, <span class="va">coordx_upr2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">coordy_lwr2</span>, <span class="va">coordy_upr2</span><span class="op">)</span></span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-28-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Similarly, for <code>alpha=1</code> with boundary correction in
region 1:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot_function</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">pred_alpha1_bc</span>, data <span class="op">=</span> <span class="st">".fitted"</span>,</span>
<span>              improve_plot<span class="op">=</span><span class="cn">TRUE</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> </span>
<span><span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>data <span class="op">=</span> <span class="st">"y"</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>, data_size <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0</span>, p <span class="op">=</span> <span class="va">p</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="va">coordx_lwr1</span>, <span class="va">coordx_upr1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">coordy_lwr1</span>, <span class="va">coordy_upr1</span><span class="op">)</span>                       </span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-29-1.png" width="672" style="display: block; margin: auto;"></p>
<p>and in region 2:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot_function</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">pred_alpha1_bc</span>, data <span class="op">=</span> <span class="st">".fitted"</span>,</span>
<span>              improve_plot<span class="op">=</span><span class="cn">TRUE</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> </span>
<span><span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>data <span class="op">=</span> <span class="st">"y"</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>, data_size <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0</span>, p <span class="op">=</span> <span class="va">p</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="va">coordx_lwr2</span>, <span class="va">coordx_upr2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">coordy_lwr2</span>, <span class="va">coordy_upr2</span><span class="op">)</span>                       </span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-30-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Now, for the Whittle-Matérn models with <code>alpha=2</code>:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_alpha2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/augment.graph_lme.html">augment</a></span><span class="op">(</span><span class="va">fit_alpha2</span>, newdata <span class="op">=</span> <span class="va">df_pred</span>,</span>
<span>                        normalized <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Let us now build the plot for region 1:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot_function</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">pred_alpha2</span>, data <span class="op">=</span> <span class="st">".fitted"</span>,</span>
<span>                    improve_plot<span class="op">=</span><span class="cn">TRUE</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> </span>
<span><span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>data <span class="op">=</span> <span class="st">"y"</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>, data_size <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0</span>, p <span class="op">=</span> <span class="va">p</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="va">coordx_lwr1</span>, <span class="va">coordx_upr1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">coordy_lwr1</span>, <span class="va">coordy_upr1</span><span class="op">)</span>                       </span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-32-1.png" width="672" style="display: block; margin: auto;"></p>
<p>and region 2:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot_function</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">pred_alpha2</span>, data <span class="op">=</span> <span class="st">".fitted"</span>,</span>
<span>                    improve_plot<span class="op">=</span><span class="cn">TRUE</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> </span>
<span><span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>data <span class="op">=</span> <span class="st">"y"</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>, data_size <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0</span>, p <span class="op">=</span> <span class="va">p</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="va">coordx_lwr2</span>, <span class="va">coordx_upr2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">coordy_lwr2</span>, <span class="va">coordy_upr2</span><span class="op">)</span>                       </span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-33-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Now with boundary correction:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_alpha2_bc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/augment.graph_lme.html">augment</a></span><span class="op">(</span><span class="va">fit_alpha2_bc</span>, newdata <span class="op">=</span> <span class="va">df_pred</span>,</span>
<span>                        normalized <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>the plot in region 1:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot_function</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">pred_alpha2_bc</span>, data <span class="op">=</span> <span class="st">".fitted"</span>,</span>
<span>                    improve_plot<span class="op">=</span><span class="cn">TRUE</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> </span>
<span><span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>data <span class="op">=</span> <span class="st">"y"</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>, data_size <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0</span>, p <span class="op">=</span> <span class="va">p</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="va">coordx_lwr1</span>, <span class="va">coordx_upr1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">coordy_lwr1</span>, <span class="va">coordy_upr1</span><span class="op">)</span>                       </span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-35-1.png" width="672" style="display: block; margin: auto;"></p>
<p>and in region 2:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot_function</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">pred_alpha2_bc</span>, data <span class="op">=</span> <span class="st">".fitted"</span>,</span>
<span>                    improve_plot<span class="op">=</span><span class="cn">TRUE</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> </span>
<span><span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>data <span class="op">=</span> <span class="st">"y"</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>, data_size <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0</span>, p <span class="op">=</span> <span class="va">p</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="va">coordx_lwr2</span>, <span class="va">coordx_upr2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">coordy_lwr2</span>, <span class="va">coordy_upr2</span><span class="op">)</span>                       </span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-36-1.png" width="672" style="display: block; margin: auto;"></p>
<p>We now move to the models based on the graph Laplacian:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_GL1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/augment.graph_lme.html">augment</a></span><span class="op">(</span><span class="va">fit_GL1</span>, newdata <span class="op">=</span> <span class="va">df_pred</span>,</span>
<span>                        normalized <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>the plot in region 1:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot_function</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">pred_GL1</span>, data <span class="op">=</span> <span class="st">".fitted"</span>, </span>
<span>                    improve_plot <span class="op">=</span> <span class="cn">TRUE</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> </span>
<span><span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>data <span class="op">=</span> <span class="st">"y"</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>, data_size <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0</span>, p <span class="op">=</span> <span class="va">p</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="va">coordx_lwr1</span>, <span class="va">coordx_upr1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">coordy_lwr1</span>, <span class="va">coordy_upr1</span><span class="op">)</span>                       </span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-38-1.png" width="672" style="display: block; margin: auto;"></p>
<p>and in region 2:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot_function</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">pred_GL1</span>, data <span class="op">=</span> <span class="st">".fitted"</span>, </span>
<span>                    improve_plot <span class="op">=</span> <span class="cn">TRUE</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> </span>
<span><span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>data <span class="op">=</span> <span class="st">"y"</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>, data_size <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0</span>, p <span class="op">=</span> <span class="va">p</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="va">coordx_lwr2</span>, <span class="va">coordx_upr2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">coordy_lwr2</span>, <span class="va">coordy_upr2</span><span class="op">)</span>                       </span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-39-1.png" width="672" style="display: block; margin: auto;"></p>
<p>and for <code>alpha=2</code>:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_GL2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/augment.graph_lme.html">augment</a></span><span class="op">(</span><span class="va">fit_GL2</span>, newdata <span class="op">=</span> <span class="va">df_pred</span>,</span>
<span>                        normalized <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>the plot in region 1:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot_function</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">pred_GL2</span>, data <span class="op">=</span> <span class="st">".fitted"</span>, </span>
<span>                    improve_plot <span class="op">=</span> <span class="cn">TRUE</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> </span>
<span><span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>data <span class="op">=</span> <span class="st">"y"</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>, data_size <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0</span>, p <span class="op">=</span> <span class="va">p</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="va">coordx_lwr1</span>, <span class="va">coordx_upr1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">coordy_lwr1</span>, <span class="va">coordy_upr1</span><span class="op">)</span>                       </span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-41-1.png" width="672" style="display: block; margin: auto;"></p>
<p>and in region 2:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot_function</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">pred_GL2</span>, data <span class="op">=</span> <span class="st">".fitted"</span>, </span>
<span>                    improve_plot <span class="op">=</span> <span class="cn">TRUE</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> </span>
<span><span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>data <span class="op">=</span> <span class="st">"y"</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>, data_size <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0</span>, p <span class="op">=</span> <span class="va">p</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="va">coordx_lwr2</span>, <span class="va">coordx_upr2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">coordy_lwr2</span>, <span class="va">coordy_upr2</span><span class="op">)</span>                       </span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-42-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Finally, for models with isotropic exponential covariance:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_isoexp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/augment.graph_lme.html">augment</a></span><span class="op">(</span><span class="va">fit_isoexp</span>, newdata <span class="op">=</span> <span class="va">df_pred</span>,</span>
<span>                        normalized <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>and the corresponding plot in region 1:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot_function</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">pred_isoexp</span>, data <span class="op">=</span> <span class="st">".fitted"</span>, </span>
<span>                    improve_plot <span class="op">=</span> <span class="cn">TRUE</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> </span>
<span><span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>data <span class="op">=</span> <span class="st">"y"</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>, data_size <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0</span>, p <span class="op">=</span> <span class="va">p</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="va">coordx_lwr1</span>, <span class="va">coordx_upr1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">coordy_lwr1</span>, <span class="va">coordy_upr1</span><span class="op">)</span>                       </span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-44-1.png" width="672" style="display: block; margin: auto;"></p>
<p>and in region 2:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot_function</span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">pred_isoexp</span>, data <span class="op">=</span> <span class="st">".fitted"</span>, </span>
<span>                    improve_plot <span class="op">=</span> <span class="cn">TRUE</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> </span>
<span><span class="va">pems_graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>data <span class="op">=</span> <span class="st">"y"</span>, vertex_size <span class="op">=</span> <span class="fl">0</span>, data_size <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                    edge_width <span class="op">=</span> <span class="fl">0</span>, p <span class="op">=</span> <span class="va">p</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="va">coordx_lwr2</span>, <span class="va">coordx_upr2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">coordy_lwr2</span>, <span class="va">coordy_upr2</span><span class="op">)</span>                       </span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-45-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="a-quick-diagnostic-analysis">A quick diagnostic analysis<a class="anchor" aria-label="anchor" href="#a-quick-diagnostic-analysis"></a>
</h2>
<p>The cross-validation suggests that the best model with respect to
RMSE, MAE, CRPS and log-score is the Whittle-Matérn field with
<code>alpha=2</code> and boundary corrections. Let the residual be given
by <span class="math display">\[e_i = y_i - \mu -
E(u(s_i)|y_1,\ldots,y_n), \quad i=1,\ldots, n.\]</span> We will consider
a standardized version of the above residual where we normalize it by
divinding by its standard deviation. Such standardized residuals are
given when using the <code>augment</code> function when the argument
<code>se_fit</code> is set to <code>TRUE</code>. Let us now compute such
residuals, then do a simple QQ plot of them.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted_aug</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/augment.graph_lme.html">augment</a></span><span class="op">(</span><span class="va">fit_alpha2_bc</span>, se_fit <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Now let us build the QQ-plot against the theoretical quantiles a
standard Gaussian distribution:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">fitted_aug</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>sample <span class="op">=</span> <span class="va">.std_resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_qq.html" class="external-link">stat_qq</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">p</span>          </span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-47-1.png" width="672" style="display: block; margin: auto;"></p>
<p>We will now do a parametric bootstrap procedure to obtain confidence
bands (simulated envelopes) for the above QQ plot. We will consider
<span class="math inline">\(B=100\)</span> bootstrap samples. We start
by generating <span class="math inline">\(B\)</span> samples. This can
be done by using the <code><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate()</a></code> method:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">B</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">samples_alpha2_bc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">fit_alpha2_bc</span>, nsim <span class="op">=</span> <span class="va">B</span><span class="op">)</span></span></code></pre></div>
<p>To reduce computational cost, we will fix the latent parameters at
the original fitted values, this can be done by passing the fitted model
as the <code>previous_fit</code> argument, and setting
<code>fix_coeff</code> to <code>TRUE</code>. We will compute the new
standardized residuals based on these new samples:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simul_std_resid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">fitted_aug</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="va">B</span><span class="op">)</span></span>
<span><span class="co"># We clone the graph to add new data</span></span>
<span><span class="va">pems_graph_new</span> <span class="op">&lt;-</span> <span class="va">pems_graph</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">B</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># We get the simulated response. Since we do not have replicates, </span></span>
<span>  <span class="co"># all of them are in the first element of the list.</span></span>
<span>  <span class="va">y_tmp</span> <span class="op">&lt;-</span> <span class="va">samples_alpha2_bc</span><span class="op">$</span><span class="va">samples</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span></span>
<span>  <span class="co"># Add new observations</span></span>
<span>  <span class="va">pems_graph_new</span><span class="op">$</span><span class="fu">add_observations</span><span class="op">(</span>data <span class="op">=</span> <span class="va">pems_graph</span><span class="op">$</span><span class="fu">mutate</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y_tmp</span><span class="op">)</span>, </span>
<span>                                  clear_obs <span class="op">=</span> <span class="cn">TRUE</span>, verbose <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">new_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_lme.html">graph_lme</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, graph<span class="op">=</span><span class="va">pems_graph_new</span>, BC <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                previous_fit <span class="op">=</span> <span class="va">fit_alpha2_bc</span>,</span>
<span>                                model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"WhittleMatern"</span>, alpha <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>                                fix_coeff <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">new_fitted_aug</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/augment.graph_lme.html">augment</a></span><span class="op">(</span><span class="va">new_fit</span>, se_fit <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>        </span>
<span>  <span class="va">simul_std_resid</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">new_fitted_aug</span><span class="op">[[</span><span class="st">".std_resid"</span><span class="op">]</span><span class="op">]</span>            </span>
<span><span class="op">}</span></span></code></pre></div>
<p>We will now create the lower and upper bands with 95% confidence, as
well as plot a median line. We being by extracting the lower, upper and
median values.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">prob</span> <span class="op">&lt;-</span> <span class="fl">0.95</span></span>
<span>  <span class="va">simul_std_resid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">simul_std_resid</span><span class="op">)</span></span>
<span>  <span class="va">simul_std_resid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">simul_std_resid</span>, <span class="fl">1</span>, <span class="va">sort</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">simul_std_resid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">simul_std_resid</span>, <span class="fl">2</span>, <span class="va">sort</span><span class="op">)</span></span>
<span>  <span class="va">id1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">B</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">prob</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">id2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">B</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">prob</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">bands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">simul_std_resid</span><span class="op">[</span><span class="va">id2</span>, <span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">simul_std_resid</span>, <span class="fl">2</span>, <span class="fu">stats</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">)</span>, <span class="va">simul_std_resid</span><span class="op">[</span><span class="va">id1</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">bands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">bands</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">bands</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"upper"</span>, <span class="st">"median"</span>, <span class="st">"lower"</span><span class="op">)</span>  </span></code></pre></div>
<p>Let us now produce the QQ plot with the confidence bands and median
line. We start by obtaining the quantile values, and add them to the
bands <code>data.frame</code>:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmp_quantiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">fitted_aug</span><span class="op">[[</span><span class="st">".std_resid"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">bands</span><span class="op">[[</span><span class="st">"x"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">tmp_quantiles</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">bands</span><span class="op">[[</span><span class="st">"y"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">tmp_quantiles</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">bands</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_path</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>, y <span class="op">=</span> <span class="va">median</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Theoretical Quantiles"</span>, y <span class="op">=</span> <span class="st">"Sample Quantiles"</span><span class="op">)</span></span>
<span><span class="va">p</span></span></code></pre></div>
<p><img src="comparison_files/figure-html/unnamed-chunk-52-1.png" width="672" style="display: block; margin: auto;"></p>
<p>By observing the QQ plot with confidence bands, we can see that the
Gaussianity assumption is reasonable; however, the fit can likely be
improved by considering non-stationary Gaussian models as latent fields.
However, it is not the goal of this vignette, as we are only comparing
exact models. Our package has an implementation for nonstationary
Gaussian models using finite element approximations.</p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Anderes2020" class="csl-entry">
Anderes, Ethan, Jesper Møller, and Jakob G Rasmussen. 2020.
<span>“Isotropic Covariance Functions on Graphs and Their Edges.”</span>
<em>Annals of Statistics</em>.
</div>
<div id="ref-BSW2022b" class="csl-entry">
Bolin, David, Alexandre B. Simas, and Jonas Wallin. 2023.
<span>“Statistical Properties of Gaussian Whittle–Matérn Fields on
Metric Graphs.”</span> <em>arXiv:2304.10372</em>.
</div>
<div id="ref-BSW2022a" class="csl-entry">
———. 2024. <span>“Gaussian Whittle–Matérn Fields on Metric
Graphs.”</span> <em>Bernoulli</em>.
</div>
<div id="ref-Borovitskiy2021" class="csl-entry">
Borovitskiy, Viacheslav, Iskander Azangulov, Alexander Terenin, Peter
Mostowsky, Marc Deisenroth, and Nicolas Durrande. 2021. <span>“Matérn
Gaussian Processes on Graphs.”</span> <em>International Conference on
Artificial Intelligence and Statistics</em>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by David Bolin, Alexandre Simas, Jonas Wallin.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>

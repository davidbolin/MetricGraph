---
title: "Data manipulation on metric graphs"
author: "David Bolin, Alexandre B. Simas, and Jonas Wallin"
date: "Created: 2022-11-23. Last modified: `r Sys.Date()`."
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data manipulation on metric graphs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(MetricGraph)
set.seed(1)
```

# Introduction

In this vignette we will provide some examples of data manipulation on metric graphs. More precisely, we will show how to add data to the metric graph, how to retrieve the data, how to do data manipulation using some of the `tidyverse` tools. Finally, we will show how add the results of these manipulations back to the metric graph.

As an example throughout the vignette, we consider the following metric graph:
```{r}
edge1 <- rbind(c(0,0),c(1,0))
edge2 <- rbind(c(0,0),c(0,1))
edge3 <- rbind(c(0,1),c(-1,1))
theta <- seq(from=pi,to=3*pi/2,length.out = 20)
edge4 <- cbind(sin(theta),1+ cos(theta))
edges = list(edge1, edge2, edge3, edge4)
graph <- metric_graph$new(edges = edges)
graph$plot()
```

For further details on the construction of metric graphs, see
[Working with metric graphs](metric_graphs.html)

# Adding and accessing data on metric graphs

Let us start by generating some data to be added to the metric graph object we created, namely `graph`. 
We first generate the locations:
```{r}
obs_per_edge <- 50
obs_loc <- NULL
for(i in 1:(graph$nE)) {
  obs_loc <- rbind(obs_loc,
                   cbind(rep(i,obs_per_edge), 
                   runif(obs_per_edge)))
}
```

Now, we will generate the data and build a `data.frame` to be added to the metric graph:

```{r}
y <- rnorm(graph$nE * obs_per_edge)

df_data <- data.frame(y=y, edge = obs_loc[,1], pos = obs_loc[,2])
```

We can now add the data to the graph by using the `add_mesh_observations()` method. We will add the data by providing the edge number and relative distance on the edge. To this end, when adding the data, we need to supply the names of the columns that contain the edge number and the distance on edge by entering the `edge_number` and `distance_on_edge` arguments. Further, since we are providing the relative distance, we need to set the `normalized` argument to `TRUE`:

```{r}
graph$add_observations(data = df_data, edge_number = "edge", distance_on_edge = "pos", normalized = TRUE)
```

We can check that the data was successfully added by retrieving them from the metric graph using the `get_data()` method:

```{r}
graph$get_data()
```

We can also visualize the data by using the `plot()` method and specifying which column we would like to plot:

```{r}
graph$plot(data = "y")
```

We can add more data to the metric graph by using the `add_observations()` method again. To this end, let us create an additional dataset. This time, we will add it using spatial coordinates. 
In this case, we will generate `50` uniform locations to be the `x` coordinate of the data, and we will keep the `y` coordinate equal to zero. Further, we will generate `50` more realizations of a standard gaussian variable as the `y2` variable. 

```{r}
coordx <- runif(50)
coordy <- 0
y2 <- rnorm(50)

df_data2 <- data.frame(y2 = y2, coordx = coordx, coordy = coordy)
```

Let us add this dataset. Now, we need to set `data_coords` to `"spatial"` and we need to supply the names of the columns of the `x` and `y` coordinates:

```{r}
graph$add_observations(data = df_data2, data_coords = "spatial", coord_x = "coordx", coord_y = "coordy")
```

Let us check that the data was successfully added:

```{r}
graph$get_data()
```

We can also plot:

```{r}
graph$plot(data = "y2")
```

Observe that `NAs` were added, since `df_data` does not contain the column `y2` and `df_data2` does not contain the column `y`.

By default, the `get_data()` method excludes all rows in which all the variables are `NA` (the location variables are not considered here). We can also show the rows that do not contain any `NA` observations by using the `drop_na` argument in the `get_data()` method:

```{r}
graph$get_data(drop_na = TRUE)
```

Observe that there is no row, since all of them contain at least one `NA`.

Suppose now that we want to replace the metric graph data by a new dataset. To this end we have two options. The first one is to use the `clear_observations()` method, then add the observations:

```{r}
graph$clear_observations()
```

We will now create the dataset we want to add. To simplify, we will use the default naming for the edge number and distance on edge, so that we do not need to specify them in the `add_observations()` method:

```{r}
y3 <- rnorm(graph$nE * obs_per_edge)

df_data3 <- data.frame(y3=y3, edge_number = obs_loc[,1], distance_on_edge = obs_loc[,2])
```

We can now add the data. Remember to set `normalized` to `TRUE` since we are providing the relative distance on edge:

```{r}
graph$add_observations(data = df_data3, normalized = TRUE)
```
and check:

```{r}
graph$get_data()
```

The second way to replace the data in the metric graph is to set the `clear_obs` argument to `TRUE`. We will also create a new dataset using the default naming for the `x` and `y` coordinates, so we do not need to specify them:

```{r}
df_data4 <- data.frame(y4 = exp(y2), coord_x = coordx, coord_y = coordy)
```
and we add them (remember to set `data_coords` to `"spatial"`):
```{r}
graph$add_observations(data = df_data4, clear_obs = TRUE, data_coords = "spatial")
```
and we can check it replaced:
```{r}
graph$get_data()
```

# Adding grouped data to metric graphs

The graph structure also allow to add grouped data. To this end we need to specify which column of the data will be the grouping variable. 

To illustrate, let us generate a grouped data. We will use the same locations we generated in the previous section.

```{r}
n.repl <- 5

y <- rnorm(n.repl * graph$nE * obs_per_edge)
repl <- rep(1:n.repl, each = graph$nE * obs_per_edge)
```

Let us now create the `data.frame` with the grouped data, where the grouping variable is `repl`:

```{r}
df_data_repl <- data.frame(y = y, repl = repl, 
                            edge_number = rep(obs_loc[,1], times = n.repl), 
                            distance_on_edge = rep(obs_loc[,2], times = n.repl))
```

We can now add this `data.frame` to the graph by using the `add_observations()` method. We need to set `normalized` to `TRUE`, since we have relative distances on edge. We also need to set the `group` argument to `repl`, since `repl` is our grouping variable. Finally, we will also set `clear_obs` to `TRUE` since we want to replace the existing data.

```{r}
graph$add_observations(data = df_data_repl, normalized = TRUE, clear_obs = TRUE, group = "repl")
```
Let us check the graph data:

```{r}
graph$get_data()
```

We can obtain the data for a given group by setting the `group` argument in the `get_data()` method:

```{r}
graph$get_data(group = "3")
```

We can also provide the group argument as a vector:

```{r}
graph$get_data(group = c("3","5"))
```

The `plot()` method works similarly. We can plot the data from a specific group by specifying which group we would like to plot:

```{r}
graph$plot(data = "y", group = "3")
```


# Manipulating data from metric graphs in the tidyverse style

(select)

behavior

NA behavior

(filter)

behavior

NA behavior

(mutate)

behavior

NA behavior

(summarise)

behavior

NA behavior

(drop_na)

behavior


(show how to obtain the result of several operations using the methods + update)

(or a single concatenated operation followed by the add_observations)

# Replacing the data in the metric graph by manipulated data

graph$add_observations(data = ..., clear_obs = TRUE)